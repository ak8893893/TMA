<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Wallet Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .button { 
            background: #3498db; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .button:hover { background: #2980b9; }
        .error { color: red; margin: 10px 0; }
        .network-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .nft-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 更新的 ERC721 ABI，包含更多方法用於調試
        const ERC721_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function name() view returns (string)",
            "function symbol() view returns (string)"
        ];

        function NFTWalletDemo() {
            const [account, setAccount] = React.useState('');
            const [nfts, setNfts] = React.useState([]);
            const [isConnected, setIsConnected] = React.useState(false);
            const [error, setError] = React.useState('');
            const [networkInfo, setNetworkInfo] = React.useState({});
            const [isLoading, setIsLoading] = React.useState(false);

            const getNetworkInfo = async () => {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    const chainId = await window.ethereum.request({ 
                        method: 'eth_chainId' 
                    });
                    setNetworkInfo({
                        name: network.name,
                        chainId: chainId
                    });
                } catch (err) {
                    console.error('獲取網絡信息錯誤:', err);
                }
            };

            const connectWallet = async () => {
                setError('');
                setIsLoading(true);
                try {
                    if (window.ethereum) {
                        const accounts = await window.ethereum.request({
                            method: 'eth_requestAccounts'
                        });
                        setAccount(accounts[0]);
                        setIsConnected(true);
                        await getNetworkInfo();
                        await fetchNFTs(accounts[0]);
                    } else {
                        setError('請安裝 MetaMask!');
                    }
                } catch (error) {
                    console.error('連接錢包錯誤:', error);
                    setError('連接錢包失敗: ' + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const fetchNFTs = async (userAddress) => {
                setError('');
                setIsLoading(true);
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    const contract = new ethers.Contract(
                        '0xc799d8f3ad911a03ac1e1f93baa2e961b4047803', // NFT合約地址
                        ERC721_ABI,
                        signer
                    );

                    // 先嘗試獲取合約基本信息
                    try {
                        const name = await contract.name();
                        const symbol = await contract.symbol();
                        console.log('Contract Info:', { name, symbol });
                    } catch (err) {
                        console.log('獲取合約信息失敗:', err);
                    }

                    // 獲取餘額
                    const balance = await contract.balanceOf(userAddress);
                    console.log('NFT Balance:', balance.toString());
                    
                    const tokenIds = [];
                    const balanceNum = balance.toNumber();

                    for (let i = 0; i < balanceNum; i++) {
                        try {
                            const tokenId = await contract.tokenOfOwnerByIndex(userAddress, i);
                            let tokenUri = '';
                            try {
                                tokenUri = await contract.tokenURI(tokenId);
                            } catch (uriError) {
                                console.log('獲取Token URI失敗:', uriError);
                                tokenUri = 'Unable to fetch URI';
                            }
                            
                            tokenIds.push({
                                id: tokenId.toString(),
                                uri: tokenUri
                            });
                        } catch (err) {
                            console.error('獲取Token ID失敗:', err);
                        }
                    }

                    setNfts(tokenIds);
                    if (tokenIds.length === 0) {
                        setError('沒有找到NFT');
                    }
                } catch (error) {
                    console.error('獲取NFT錯誤:', error);
                    setError('獲取NFT失敗: ' + (error.message || '未知錯誤'));
                } finally {
                    setIsLoading(false);
                }
            };

            // 監聽網絡變更
            React.useEffect(() => {
                if (window.ethereum) {
                    window.ethereum.on('chainChanged', (chainId) => {
                        getNetworkInfo();
                        if (account) {
                            fetchNFTs(account);
                        }
                    });
                }
            }, [account]);

            return (
                <div className="container">
                    <h1>NFT 展示 Demo</h1>
                    
                    {!isConnected ? (
                        <button className="button" onClick={connectWallet} disabled={isLoading}>
                            {isLoading ? '連接中...' : '連接錢包'}
                        </button>
                    ) : (
                        <div>
                            <div className="network-info">
                                <p>錢包地址: {account}</p>
                                <p>網絡名稱: {networkInfo.name}</p>
                                <p>Chain ID: {networkInfo.chainId}</p>
                            </div>

                            {error && <div className="error">{error}</div>}
                            
                            {isLoading ? (
                                <p>正在加載NFT數據...</p>
                            ) : (
                                <div className="nft-grid">
                                    {nfts.map((nft) => (
                                        <div key={nft.id} className="nft-card">
                                            <h3>Token ID: {nft.id}</h3>
                                            <p>Token URI: {nft.uri}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NFTWalletDemo />);
    </script>
</body>
</html>